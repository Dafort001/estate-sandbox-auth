
# Pix.immo – Sprint 1 Development Brief (Replit)

## Goal
Build a minimal end-to-end workflow for **one photo shoot**:  
Upload → Intake (bucket sorting & stacking) → Handoff package → Editor upload → Automated job triggers.

---

## Scope (MVP)

### 1. Job & Shoot Creation
- `POST /api/jobs` creates a `job_id` and a human-readable `job_number`.
- `POST /api/uploads/init { jobNumber }`  
  → returns an active `shoot_id` and short `shoot_code` (5-character alias).  
  → if no open shoot exists, a new one is created automatically.

---

### 2. Intake (Uploader Interface)
**Frontend:**
- Drag-and-drop a full folder (e.g. `RAW_5` or `RAW_3`).
- **Auto-stacking:** group files sequentially into 5- or 3-image stacks (`g001`, `g002`, …).  
  Each stack can be toggled between “5-frame” and “3-frame”.
- **Room-type bucket assignment:** dropdown per stack (`living_room`, `kitchen`, `bathroom`, `undefined_space`, …).  
  (AI suggestions optional.)
- **Review tools:** mini thumbnails per stack, “unsorted only” filter, multi-select, and keyboard shortcuts.
- **Finalize:** preview of the generated filenames, then start upload.

**Backend logic:**
- Create stacks and assign room types.
- Rename RAW files for the editor handoff (flat directory):

  ```
  {date}-{shootcode}_{room_type}_{index}_g{stack}_e{ev}.{ext}
  ```

- Store sidecars:  
  `meta/images/{image_id}.json`,  
  `meta/intake_manifest_{shoot_id}.json`.

---

### 3. Handoff Package Generation
- `POST /api/projects/:jobId/handoff/:shootId`
- Builds one ZIP package containing:
  - `raw/` (flat directory with renamed RAWs)  
  - `handoff/manifest_{shoot_id}.json`  
  - `handoff/README_{shoot_id}.txt`  
  - `handoff/editor_briefing_{shoot_id}.json` (placeholders are fine)
- Returns a **signed download link** (valid for 36 hours).
- Also generates a **signed upload link** for the editor (single ZIP return).

---

### 4. Editor Upload
- Endpoint: `POST /api/editor/:token/upload` (resumable, one ZIP only).  
- Unzip to `/edits/{shoot_id}/final/`.
- Validate against the handoff manifest:
  - expected outputs per `stack_id`
  - file count & filenames
- Write validation results to `meta/return_manifest_{shoot_id}.json`.

---

### 5. Automated Job Triggers
After editor upload:
- Set status = `edited_returned`.
- Trigger background queue (stub implementation ok):
  - **Downscale** to 3000 px sRGB Q85.
  - **Caption / OCR / Exposé generation** (can be stubbed in this sprint).
- Apply **quiet-window delay = 60 minutes** before triggering downstream jobs.

---

### 6. Notifications
- Send both **email** and **SMS** notifications to the producer.  
  (Simple text stubs are fine.)
- **Do not** use WhatsApp.

---

## Out of Scope (for later sprints)
- Full AI room detection or captioning.  
- Customer-facing gallery and export system.

---

## R2 / Storage Structure
```
/projects/{job_id}/
  raw/{shoot_id}/...
  edits/{shoot_id}/final/...
  handoff/manifest_{shoot_id}.json
  handoff/README_{shoot_id}.txt
  handoff/editor_briefing_{shoot_id}.json
  meta/images/{image_id}.json
  meta/intake_manifest_{shoot_id}.json
  meta/return_manifest_{shoot_id}.json
```

---

## Filename Rules (v3.1 – final)

**Final edited JPGs (after editor return):**
```
{date}-{shootcode}_{room_type}_{index}_v{ver}.jpg
```

**RAW files in the editor handoff (flat structure):**
```
{date}-{shootcode}_{room_type}_{index}_g{stack}_e{ev}.{ext}
```

- `date` → EXIF DateTimeOriginal (fallback: upload timestamp)  
- `shootcode` → first 5 chars of `shoot_id`  
- `room_type` → selected during intake (fallback `undefined_space`)  
- `index` → sequential per (shoot_id + room_type)  
- `v{ver}` → version number, starting at 1  

---

## Acceptance Criteria

| ID | Test | Expected Result |
|----|------|-----------------|
| **A1** | `uploads/init` with valid jobNumber | returns shoot_id + shoot_code |
| **A2** | Upload 15 files from `RAW_5` | creates stacks g001–g003 (5 files each) |
| **A3** | Room-type assignment per stack | works; fallback `undefined_space` |
| **A4** | Renamed RAWs | follow pattern `{date}-{shootcode}_{room_type}_{index}_g{stack}_e{ev}.{ext}` |
| **A5** | Handoff ZIP | flat `raw/` + 3 metadata files; signed 36 h link |
| **A6** | Editor upload | accepts 1 ZIP → unzipped to `/edits/{shoot_id}/final/`; creates `return_manifest` |
| **A7** | Trigger logic | queue stub runs; quiet-window 60 min enforced |
| **A8** | Notifications | email + SMS (stub) sent |

---

## Constants / Defaults
- Standard deadline: **36 hours**  
- Quiet-window: **60 minutes**
- `room_type` list v1.1 (includes `undefined_space`, excludes “music room”)  
- No `shot_type` field used.  
- Filenames kept short (no pixel size in names).

---

## Required Inputs from Pix.immo
- Initial `room_type` list (if not provided, use a short default list).  
- Access credentials for R2 (S3-compatible), email service (Mailgun etc.), SMS service (Twilio etc.).  
- Domain / route for signed download + upload links (editor access).

---

## Acceptance Definition
✅ A working Intake UI that can bucket and stack files, generate correct filenames and manifests,  
produce one ZIP for the editor, receive one ZIP back, validate it, and trigger downstream queues  
with email + SMS notification stubs.
